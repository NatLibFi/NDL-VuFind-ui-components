<?php
  $attributes = $attributes ?? [];
  $renderChildren = $renderChildren ?? 'dropdown';
  $classes = [];
  if (!empty($children) && 'dropdown' === $renderChildren) {
    $classes[] = 'dropdown';
  }
  elseif (isset($active) ? boolval($active) : false) {
    $classes[] = 'active';
    $attributes['aria-current'] = 'page';
  }
  if (!empty($classes)) {
    $attributes['class'] = (array)($attributes['class'] ?? []);
    $attributes['class'] = array_merge($attributes['class'], $classes);
  }

  // Process child attributes if necessary.
  if (!empty($children) && 'false' !== $renderChildren) {
    foreach ($children as $i => $child) {
      $child['attributes'] = $child['attributes'] ?? [];
      $childClasses = [];
      if (isset($child['active']) ? boolval($child['active']) : false) {
        $attributes['class'] = (array)($attributes['class'] ?? []);
        $attributes['class'][] = 'active-trail';
        $childClasses[] = 'active';
        $child['attributes']['aria-current'] = 'page';
      }
      if ($hasDescription = !empty($child['description'])) {
        $childClasses[] = 'nav-item-has-description';
      }
      if (!empty($childClasses)) {
        $child['attributes']['class'] = (array)($child['attributes']['class'] ?? []);
        $child['attributes']['class'] = array_merge($child['attributes']['class'], $childClasses);
      }
      $child['linkAttributes'] = $child['linkAttributes'] ?? [];
      $child['linkAttributes']['href'] = $child['link'];
      $children[$i] = $child;
    }
  }
?>
<li<?= $this->attributes($attributes) ?>>
  <?php if (!empty($children) && 'dropdown' === $renderChildren): ?>
    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
      aria-expanded="false"><?= $label ?> <b class="caret"></b></a>
  <?php else: ?>
    <a href="<?= $link ?>"<?php if (!empty($target)): ?> target="<?= $target ?>"<?php endif; ?>><?= $label ?></a>
    <?php if (!empty($tooltipBtn)): ?>
      <?= $this->render('components/molecules/tooltips/finna-tooltip-btn/finna-tooltip-btn.phtml', $tooltipBtn) ?>
    <?php endif; ?>
  <?php endif; ?>
  <?php if (!empty($children) && 'false' !== $renderChildren): ?>
    <ul<?php if ('simple' !== $renderChildren): ?> class="dropdown-menu"<?php endif; ?>>
      <?php foreach ($children as $child): ?>
        <li<?= $this->attributes($child['attributes']) ?>>
          <a<?= $this->attributes($child['linkAttributes']) ?>><span><?= $child['label'] ?></span>
          <?php if ($hasDescription): ?><span role="note"><?= $child['description'] ?></span><?php endif; ?></a>
        </li>
      <?php endforeach; ?>
    </ul>
  <?php endif; ?>
</li>
